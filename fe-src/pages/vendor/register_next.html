<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="万木家厂家后台" />

    <title>万木家厂家后台 - {% if form.is_reconfirm -%} 重新审核 {%- else -%} 注册 {%- endif %}</title>

    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Arimo:400,700,400italic">
    <link rel="stylesheet" href="/lib/xenon/css/fonts/linecons/css/linecons.css">
    <link rel="stylesheet" href="/lib/xenon/css/fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/xenon/css/bootstrap.css">
    <link rel="stylesheet" href="/lib/xenon/css/xenon-core.css">
    <link rel="stylesheet" href="/lib/xenon/css/xenon-forms.css">
    <link rel="stylesheet" href="/lib/xenon/css/xenon-components.css">
    <link rel="stylesheet" href="/lib/xenon/css/xenon-skins.css">
    <link rel="stylesheet" href="/css/vendor/custom.css">

    <script src="/lib/xenon/js/jquery-1.11.1.min.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/lib/xenon/js/html5shiv.min.js"></script>
    <script src="/lib/xenon/js/respond.min.js"></script>
    <![endif]-->


</head>

<body class="page-body login-page register-page" data-page="{% if form.is_reconfirm -%} is_reconfirm {%- else -%} register-next {%- endif %}">

<div class="login-container" >

    <div class="row">

        <div class="col-sm-6">

            <!-- Errors container -->
            <div class="errors-container">


            </div>

            <!-- Add class "fade-in-effect" for login form effect -->
            <form method="post" role="form" id="register" class="register-next-form fade-in-ffect">
                {{ form.csrf_token }}
                <div class="login-header">
                    <a href="/vendor/login" class="logo">
                        <img src="/img/logo_white.png" alt="" width="150" />
                        <span>厂家入驻</span>
                    </a>
                </div>

                {% if not form.is_reconfirm %}
                    <div class="form-group">
                        <label class="control-label" for="email">邮箱</label>
                        {{ form.email(class='form-control input-dark', **{
                            'autocomplete': 'off',
                        }) }}
                    </div>

                    <div class="form-group">
                        <label class="control-label" for="password">密码</label>
                        {{ form.password(class='form-control input-dark', **{
                            'autocomplete': 'off',
                        }) }}
                    </div>

                    <div class="form-group">
                        <label class="control-label" for="confirm_password">再次输入密码</label>
                        {{ form.confirm_password(class='form-control input-dark', **{
                            'autocomplete': 'off',
                        }) }}
                    </div>
                {% endif %}

                <div class="form-group">
                    <label class="control-label" for="agent_name">代理人真实姓名</label>
                    {{ form.agent_name(class='form-control input-dark', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group">
                    <label class="control-label" for="agent_identity">代理人身份证号</label>
                    {{ form.agent_identity(class='form-control input-dark', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group upload">
                    <label class="control-label" for="agent_identity_front">身份证正面照片</label>
                    {{ form.agent_identity_front(class='form-control input-dark', accept='image/jpeg, image/png') }}

                    <span class="upload-state fa fa-spin fa-circle-o-notch"></span>

                    <div class="img-preview">
                        <img src="{{ form.agent_identity_front_url }}" alt="身份证正面照片预览"/>
                    </div>
                </div>

                <div class="form-group upload">
                    <label class="control-label" for="agent_identity_back">身份证反面照片</label>
                    {{ form.agent_identity_back(class='form-control input-dark', accept='image/jpeg, image/png') }}

                    <span class="upload-state fa fa-spin fa-spin fa-circle-o-notch"></span>

                    <div class="img-preview">
                        <img src="{{ form.agent_identity_back_url }}" alt="身份证反面照片预览"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label" for="name">品牌厂家名称</label>
                    {{ form.name(class='form-control input-dark', maxLength='20', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group upload">
                    <label class="control-label" for="license_image">营业执照照片</label>
                    {{ form.license_image(class='form-control input-dark', accept='image/jpeg, image/png') }}

                    <span class="upload-state fa fa-spin fa-circle-o-notch"></span>

                    <div class="img-preview">
                        <img src="{{ form.license_image_url }}" alt="营业执照照片预览"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label" for="license_limit">营业期限</label>
                    {{ form.license_limit(class='form-control input-dark', placeholder='格式: 年/月/日, 例: 2015/07/19', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group">
                    <label class="control-label" for="telephone">联系固话</label>
                    {{ form.telephone(class='form-control input-dark', placeholder='区号-电话号码', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group address-select">
                    <label class="control-label" for="district_cn_id">联系地址</label>
                    <select class="form-control" name="province_cn_id" id="province_cn_id" data-province-default="{{ form.province }}"></select>
                    <select class="form-control" name="city_cn_id" id="city_cn_id" data-city-default="{{ form.city }}"></select>
                    <select class="form-control" name="district_cn_id" id="district_cn_id" data-district-default="{{ form.district }}"></select>
                </div>


                <div class="form-group">
                    <label class="control-label" for="address">联系地址 详细地址</label>
                    {{ form.address(class='form-control input-dark', **{
                        'autocomplete': 'off',
                    }) }}
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-dark  btn-block text-left">
                        <i class="fa-check"></i>
                        完成
                    </button>
                </div>
            </form>

            {% if not form.is_reconfirm %}
                <div class="external-login">
                    <a href="/vendor/login" class="facebook">
                        已经入驻？点击进行登录
                    </a>
                </div>
            {% endif %}
        </div>

    </div>

</div>

<!-- Some init operation -->
<script type="text/javascript">
    jQuery(document).ready(function($)
    {
        // Reveal Register form
        setTimeout(function(){ $(".fade-in-effect").addClass('in'); }, 1);

        // LinkageSel
        var defVal = {
            province: parseInt($('#province_cn_id').data('province-default')),
            city: parseInt($('#city_cn_id').data('city-default')),
            district: parseInt($('#district_cn_id').data('district-default')),
        };
        var districtIdSel = new LinkageSel({
            data: address,
            select: ['#province_cn_id', '#city_cn_id', '#district_cn_id'],
            defVal: [defVal.province, defVal.city, defVal.district],
        });

        // FileReader
        var imgFiles = {};
        var latestUpload = {name: '', completed: false};

        $('input[type="file"]').on('change', function () {
            var $this = $(this);
            var files = !!this.files ? this.files : [];

            if (files.length <= 0 || !window.FileReader) return;

            if (/^image/.test(files[0].type)) {
                var $formGroup = $this.parent();
                var $uploadState = $formGroup.find('.upload-state');
                var loadingClass = 'fa-spin fa-spin fa-circle-o-notch';
                var completeClass = 'fa-smile-o';
                var inputName = $this[0].name;

                // 一旦有文件开始上传更改上传状态为未完成
                latestUpload.name = inputName;
                latestUpload.completed = false;

                // update loading ui
                $uploadState
                    .removeClass(completeClass).addClass(loadingClass)
                    .show();

                uploadComplete = false;
                var reader = new FileReader();
                reader.readAsDataURL(files[0]);
                reader.onloadend = function () {
                    imgFiles[$this[0].name] = this.result;

                    // 当最后一个文件上传完成时更改上传状态为完成
                    if (latestUpload.name == inputName) {
                        latestUpload.completed = true;
                    }

                    $uploadState.removeClass(loadingClass).addClass(completeClass);

                    $formGroup.find('.img-preview')
                            .show()
                            .children('img')
                            .attr('src', this.result);

                };
            }
        });

        // Validation and Ajax action
        $("form#register").validate({

            // Form Processing via AJAX
            submitHandler: function(form)
            {
                var opts = {
                    "closeButton": true,
                    "debug": false,
                    "positionClass": "toast-top-full-width",
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "1000",
                    "timeOut": "5000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                };

                // 如果 uploadComplete 为 false，给出提示然后直接退出当前函数
                if (latestUpload.completed == false) {
                    toastr.warning('文件还在上传中' + " :)", "请稍后再提交", opts);
                    return;
                }

                show_loading_bar(70); // Fill progress bar to 70% (just a given value)

                $.ajax({
                    url: "/vendor/register",
                    method: 'POST',
                    dataType: 'json',
                    data: genFormData($(form), imgFiles),
                    success: function(resp)
                    {
                        show_loading_bar({
                            delay: .5,
                            pct: 100,
                            finish: function(){

                                // Redirect after successful login page (when progress bar reaches 100%)
                                if(resp.accessGranted) {
                                    var countdown = 3;
                                    var message = '审核结果将在3个工作日通知。后台部分功能将在审核通过后开放。\n'+
                                    countdown +'秒后自动跳转至后台首页...';

                                    toastr.success(message, '注册成功 :)', opts);
                                    setTimeout(function () {
                                        window.location.href = '/vendor';
                                    }, countdown * 1000);
                                }
                                else {
                                    toastr.error(resp.message + " :)", "注册失败", opts);
                                }
                            }
                        });

                    },
                    error: function (xhr) {
                        show_loading_bar({
                            delay: .5,
                            pct: 100,
                            finish: function(){
                                toastr.error(xhr.status + "错误，请稍后重试 :)", "服务器错误", opts);
                            }
                        });
                    }
                });
            }
        });

        // Set Form focus
        $("form#login .form-group:has(.form-control):first .form-control").focus();
    });
</script>

<!-- Bottom Scripts -->
<script src="/lib/xenon/js/bootstrap.min.js"></script>
<script src="/lib/xenon/js/TweenMax.min.js"></script>
<script src="/lib/xenon/js/resizeable.js"></script>
<script src="/lib/xenon/js/joinable.js"></script>
<script src="/lib/xenon/js/xenon-api.js"></script>
<script src="/lib/xenon/js/xenon-toggles.js"></script>
<script src="/lib/xenon/js/jquery-validate/jquery.validate.min.js"></script>
<script src="/lib/xenon/js/toastr/toastr.min.js"></script>
<script src="/lib/linkagesel-min.js"></script>
<script src="/js/address.js"></script>


<!-- JavaScripts initializations and stuff -->
<script src="/lib/xenon/js/xenon-custom.js"></script>
<script src="/lib/md5.js"></script>
<script src="/js/util.js"></script>
<script src="/js/vendor/custom.js"></script>

</body>
</html>
